name: Provision Azure User

on:
  repository_dispatch:
    types: [onboard_user]

jobs:
  provision:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        # This 'env' block makes the secrets available as environment variables for this step ONLY.
        # Terraform automatically looks for environment variables prefixed with TF_VAR_
        # and uses them to populate its input variables.
        env:
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          # Notice the credentials are NO LONGER passed in the command itself.
          # Terraform will find them in the environment variables.
          terraform apply -auto-approve \
            -var="user_display_name=${{ github.event.client_payload.user_display_name }}" \
            -var="user_alias=${{ github.event.client_payload.user_alias }}" \
            -var="domain=${{ github.event.client_payload.domain }}"

      - name: Output results
        run: terraform output -json > tf_output.json

      - name: Post back to Jira
        # The Jira secrets are still needed here, of course.
        run: |
          UPN=$(jq -r '.new_user_upn.value' tf_output.json)
          TEMP_PASS=$(jq -r '.temporary_password.value' tf_output.json)
          curl -u ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} \
            -X POST \
            --data "{\"body\": \"âœ… User Created: ${UPN}\nðŸ”‘ Temporary Password: ${TEMP_PASS}\"}" \
            -H "Content-Type: application/json" \
            https://yourcompany.atlassian.net/rest/api/3/issue/${{ github.event.client_payload.jira_issue_key }}/comment
