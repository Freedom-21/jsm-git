name: Provision Azure User

on:
  repository_dispatch:
    types: [onboard_user]

jobs:
  provision:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Debug Secrets
        run: |
          if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
            echo "::error::AZURE_CLIENT_ID secret is NOT available."
            exit 1
          else
            echo "AZURE_CLIENT_ID secret is available."
          fi
          
          if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "::error::AZURE_TENANT_ID secret is NOT available."
            exit 1
          else
            echo "AZURE_TENANT_ID secret is available."
          fi

      - name: Terraform Init
        working-directory: ./
        run: terraform init

      - name: Terraform Apply
        working-directory: ./
        run: |
          terraform apply -auto-approve \
            -var="user_display_name=${{ github.event.client_payload.user_display_name }}" \
            -var="user_alias=${{ github.event.client_payload.user_alias }}" \
            -var="domain=${{ github.event.client_payload.domain }}" \

        env:
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}

      - name: Output results
        run: terraform output -json > tf_output.json

      - name: Post back to Jira
        run: |
          UPN=$(jq -r '.new_user_upn.value' tf_output.json)
          TEMP_PASS=$(jq -r '.temporary_password.value' tf_output.json)
          curl -u ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} \
            -X POST \
            --data "{\"body\": \"âœ… User Created: ${UPN}\nðŸ”‘ Temporary Password: ${TEMP_PASS}\"}" \
            -H "Content-Type: application/json" \
            https://yourcompany.atlassian.net/rest/api/3/issue/${{ github.event.client_payload.jira_issue_key }}/comment
