name: Provision Azure User

on:
  repository_dispatch:
    types: [onboard_user]

jobs:
  provision:
    runs-on: ubuntu-latest
    # REMOVED a single line here: "environment: dev"
    # This job will now use Repository Secrets by default.
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        # This is the most reliable way to pass secrets to Terraform.
        # It reads them from the repository secrets and sets them as 
        # environment variables for this step.
        env:
          TF_VAR_client_id: ${{ secrets.AZURE_CLIENT_ID }}
          TF_VAR_client_secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          TF_VAR_tenant_id: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          # The command remains clean, with credentials handled by the 'env' block.
          terraform apply -auto-approve \
            -var="user_display_name=${{ github.event.client_payload.user_display_name }}" \
            -var="user_alias=${{ github.event.client_payload.user_alias }}" \
            -var="domain=${{ github.event.client_payload.domain }}"

      - name: Output results
        run: terraform output -json > tf_output.json

      - name: Post back to Jira
        run: |
          UPN=$(jq -r '.new_user_upn.value' tf_output.json)
          TEMP_PASS=$(jq -r '.temporary_password.value' tf_output.json)
          
          JSON_PAYLOAD=$(jq -n \
            --arg upn "$UPN" \
            --arg temp_pass "TEMP_PASS" \
            '{
              "body": {
                "type": "doc",
                "version": 1,
                "content": [
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "text": "âœ… User Created: \($upn)",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "type": "paragraph",
                    "content": [
                      {
                        "text": "ðŸ”‘ Temporary Password: \($temp_pass)",
                        "type": "text"
                      }
                    ]
                  }
                ]
              }
            },
          )
          curl -u ${{ secrets.JIRA_USER_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} \
            -X POST \
            --data "$JSON_PAYLOAD" \
            -H "Content-Type: application/json" \
            https://freedom21.atlassian.net/rest/api/3/issue/${{ github.event.client_payload.jira_issue_key }}/comment
